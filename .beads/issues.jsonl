{"id":"avemu-2qg","title":"Fix 724 commands failing match roundtrip across 14 protocols","description":"Health check TestCommandMatchRoundtrip found 724 commands that cannot match their own template. Affected brands: Bryston, McIntosh, OPPO, Simaudio, Tascam, TEAC. Root causes likely include: commands with embedded special chars in templates, regex escaping issues in match patterns, or EOL handling edge cases.","notes":"## Analysis (2026-02-08)\n\n### Affected protocols (14 brands, 724 commands)\n- bryston/bdp3, bryston/bp17\n- mcintosh/ma7900\n- oppo/bdp103, bdp103d, bdp105, bdp105d, bdp83, bdp83se, bdp93, bdp95\n- simaudio/moon750d\n- tascam/cda750\n- teac/trd2000\n\n### Root cause\nCommands built from their own templates (with no parameters) fail to match back through \\`match_command()\\`. The test builds \\`(command.command + eol).encode(encoding)\\` and passes it to \\`cb.match_command(raw)\\`. When match returns None, the command can't be recognized.\n\nLikely causes per brand:\n- **OPPO BDP series**: These are older BDP models (not UDP). May have different command format than UDP-203/205 which already works.\n- **Bryston/McIntosh/Simaudio/Tascam/TEAC**: Likely template patterns with special regex characters that aren't properly escaped in \\`_build_match_pattern()\\`\n- **All brands**: Could also be EOL handling — template has EOL embedded but match_command strips it differently\n\n### Code path\n1. \\`CommandBuilder._build_match_pattern()\\` (commands.py) converts command template to regex\n2. \\`CommandBuilder.match_command()\\` (commands.py:387) receives raw bytes, decodes, strips EOL, tries each pattern\n3. Failure means the regex doesn't match the literal command string\n\n### Investigation needed\n- Pick one failing command from each brand and trace through _build_match_pattern()\n- Check if templates contain regex metacharacters (?, +, *, (, ), [, ]) that need escaping\n- Check if OPPO BDP templates differ structurally from UDP templates\n- The EOL stripping fix (strip command_eol) was already applied — verify it works for these protocols\n\n### Fix strategy\n1. Add regex escaping for literal characters in command templates before building match patterns\n2. May need protocol-specific template parsing adjustments\n3. Test with \\`cb._build_match_pattern(command)\\` directly to see what regex is generated\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestCommandMatchRoundtrip -v\\`\n\n### Related issues\n- avemu-ms8: Raw regex in responses (overlapping — if match fails, response gen also fails)","status":"open","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:20:55.255294-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:52:54.798364-08:00"}
{"id":"avemu-4eq","title":"Restructure Capabilities model to preserve all protocol metadata","description":"The Capabilities model (schema.py:807) currently uses extra='ignore', silently dropping 379 unique capability fields that protocols define. These fields contain useful metadata for upstream libraries, UX, and device discovery. Need to restructure to preserve all data while providing typed access to common fields.","notes":"## Analysis (2026-02-08)\n\n### Current state\n- 379 unique capability field names across all protocols\n- Current Capabilities model has ~12 typed fields + extra='ignore'\n- Most protocol-defined fields are silently dropped on load\n- 170 protocols fail validation because field types don't match\n\n### Field usage distribution\n- 110 fields used by 5+ protocols\n- 111 fields used by 2-4 protocols\n- 158 fields used by only 1 protocol\n\n### Top 20 most common fields (out of 379)\n| Field | Protocols | Current model? |\n|-------|-----------|----------------|\n| features | 1064 | YES (list[str]) |\n| zones | 574 | YES (int) |\n| max_volume | 467 | YES (int\\|float) |\n| channels | 366 | NO — dropped |\n| volume_step | 317 | NO — dropped |\n| hdmi_inputs | 274 | NO — dropped |\n| min_volume | 248 | NO — dropped |\n| hdmi_outputs | 215 | YES (int) |\n| hdmi_version | 179 | NO — dropped |\n| amplifier_channels | 140 | NO — dropped |\n| analog_inputs | 134 | NO — dropped |\n| inputs | 119 | NO — dropped |\n| digital_inputs | 109 | NO — dropped |\n| power_output_watts | 104 | NO — dropped |\n| power_output | 91 | NO — dropped |\n| hdmi | 75 | NO — dropped |\n| volume_step_db | 72 | YES (float) |\n| max_volume_db | 70 | YES (float) |\n| min_volume_db | 70 | YES (float) |\n| hdmi_8k | 63 | NO — dropped |\n\n### Fields needing type restructuring\n**Dict values (need sub-model or flexible type):**\n- channels (74 use dict like {processing: 11.4, amplified: 7})\n- hdmi (75 use dict like {inputs: 7, outputs: 2, version: \"2.1\"})\n- inputs (10 use dict like {analog: 8, digital: 4})\n- outputs (7 use dict like {balanced: 2, single_ended: 2})\n- power_output (16 use dict like {per_channel_8ohm: 200})\n- digital_inputs (2 use dict like {coaxial: 8, toslink: 3})\n\n**Mixed bool/int types:**\n- balanced_inputs (33 int, 4 bool)\n- balanced_outputs (24 bool, 23 int)\n- single_ended_inputs (14 int, 2 bool)\n- single_ended_outputs (21 int, 5 bool)\n\n### Proposed fix strategy\n\n**Approach: Structured categories + extra='allow'**\n\n```python\nclass AudioCapabilities(BaseModel):\n    model_config = ConfigDict(extra='allow')\n    amplifier_channels: int | None = None\n    amplifier_class: str | None = None\n    power_output_watts: int | None = None\n    balanced_inputs: int | None = None\n    balanced_outputs: int | None = None\n    # etc.\n\nclass VideoCapabilities(BaseModel):\n    model_config = ConfigDict(extra='allow')\n    hdmi_inputs: int | None = None\n    hdmi_outputs: int | None = None\n    hdmi_version: str | None = None\n    # etc.\n\nclass Capabilities(BaseModel):\n    model_config = ConfigDict(extra='allow')  # \u003c-- preserve unknown fields\n    zones: int = 1\n    features: list[str] = []\n    unsupported: list[str] = []\n    audio: AudioCapabilities | None = None\n    video: VideoCapabilities | None = None\n    # ... keep existing typed fields\n```\n\nThe key change is `extra='allow'` instead of `extra='ignore'` — this preserves ALL fields even if they're not explicitly typed. Typed fields get validation; unknown fields pass through as-is.\n\n### Normalization needed\nMany fields have inconsistent types across protocols:\n- balanced_outputs: sometimes bool (has them), sometimes int (count)\n- digital_inputs: sometimes int, sometimes dict\n- max_volume: int, float, or None\n\nPre-validators should normalize these (e.g., bool -\u003e 0/1 for count fields, dict -\u003e extract total for int fields).\n\n### Files to modify\n- avcontrol/pyavcontrol/schema.py: Capabilities model\n- May need migration: existing code accessing capabilities fields\n\n### Verification\nRun: uv run --python 3.12 pytest tests/test_protocol_health.py -v\n\n### Related issues\n- avemu-m5z: 170 of the 429 schema validation failures are in capabilities","status":"open","priority":2,"issue_type":"feature","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T07:56:06.270632-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:56:06.270632-08:00"}
{"id":"avemu-71h","title":"Migrate avemu to pyavcontrol 2.0 API","description":"Migrate avemu emulator from the legacy pyavcontrol v1.0 API to the new v2.0 API. This includes using ProtocolLibrary, EmulatorClient, and the new YAML-based protocol definitions with 6-layer architecture.\n\n## Scope\n- Replace DeviceModelLibrary with ProtocolLibrary\n- Replace custom DefaultHandler with EmulatorClient \n- Support new protocol ID format (slash-separated: mcintosh/mx160)\n- Update framing/protocol structure access\n- Add stateful emulation capabilities\n- Update CLI and documentation\n\n## Success Criteria\n- All existing supported devices work with new API\n- Emulator correctly responds to commands using new EmulatorClient\n- Tests pass\n- Documentation updated","status":"closed","priority":2,"issue_type":"epic","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:45:27.525957-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:12.57044-08:00","closed_at":"2026-01-13T20:01:12.570442-08:00"}
{"id":"avemu-71h.1","title":"Update pyavcontrol dependency to v2.0.0+","description":"Update pyproject.toml and requirements.txt to use pyavcontrol v2.0.0 or later.\n\n## Changes\n- Update pyproject.toml dependency version\n- Update requirements.txt\n- Consider using local development path during migration: `pyavcontrol @ file:///path/to/avcontrol/avcontrol`\n\n## Files to modify\n- pyproject.toml\n- requirements.txt\n\n## Acceptance\n- pyavcontrol \u003e=2.0.0 dependency is properly specified\n- Package can be installed successfully","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:45:48.817615-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:26.422085-08:00","closed_at":"2026-01-13T20:14:26.422085-08:00","close_reason":"Completed during pyavcontrol 1.0 migration","labels":["core"],"dependencies":[{"issue_id":"avemu-71h.1","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:45:48.819372-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.10","title":"Add integration tests for emulator","description":"Create integration tests to verify avemu works correctly with pyavcontrol 2.0.\n\n## Test Scenarios\n1. Load protocol via ProtocolLibrary\n2. Create EmulatorClient\n3. Process query commands (e.g., !POWER?)\n4. Process set commands (e.g., !POWER(1))\n5. Verify state updates after set commands\n6. Test multiple protocols (mcintosh, lyngdorf, etc.)\n\n## Test Structure\n```python\n# tests/test_emulator.py\nimport pytest\nfrom pyavcontrol import ProtocolLibrary, EmulatorClient\n\n@pytest.fixture\ndef library():\n    return ProtocolLibrary()\n\n@pytest.fixture  \ndef mcintosh_emulator(library):\n    protocol = library.load('mcintosh/mx160')\n    return EmulatorClient(protocol)\n\ndef test_power_query(mcintosh_emulator):\n    response = mcintosh_emulator.process_command(b'!POWER?\\r')\n    assert b'!POWER' in response\n\ndef test_power_set(mcintosh_emulator):\n    mcintosh_emulator.process_command(b'!POWER(1)\\r')\n    assert mcintosh_emulator.state.get('power') == True\n```\n\n## Files to create\n- tests/test_emulator.py\n- tests/conftest.py (fixtures)\n\n## Acceptance\n- Tests cover core emulation scenarios\n- Tests pass with pyavcontrol 2.0\n- CI/CD can run tests","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:55.359529-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:26.425752-08:00","closed_at":"2026-01-13T20:14:26.425752-08:00","close_reason":"Completed during pyavcontrol 1.0 migration","labels":["testing"],"dependencies":[{"issue_id":"avemu-71h.10","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:55.360183-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.10","depends_on_id":"avemu-71h.4","type":"blocks","created_at":"2026-01-13T19:48:16.439194-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.11","title":"Update README documentation","description":"Update README.md to reflect pyavcontrol 2.0 API changes.\n\n## Documentation Updates\n1. Update usage examples with new protocol ID format\n2. Document both underscore and slash formats\n3. Update architecture description\n4. Remove references to DefaultHandler internals\n5. Add examples of stateful emulation\n6. Update version requirements\n\n## Example Updates\n```bash\n# Old format (still supported)\npython avemu.py --model mcintosh_mx160\n\n# New format (preferred)\npython avemu.py --model mcintosh/mx160\n```\n\n## Files to modify\n- README.md\n\n## Acceptance\n- Documentation accurate for pyavcontrol 2.0\n- Examples work as documented\n- Migration notes included for existing users","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:56.391312-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:26.427851-08:00","closed_at":"2026-01-13T20:14:26.427851-08:00","close_reason":"Completed during pyavcontrol 1.0 migration","labels":["docs"],"dependencies":[{"issue_id":"avemu-71h.11","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:56.391993-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.11","depends_on_id":"avemu-71h.4","type":"blocks","created_at":"2026-01-13T19:48:18.065734-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.12","title":"End-to-end testing with ha-conductor","description":"Test avemu with the Home Assistant ha-conductor integration to ensure full stack works.","status":"open","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:58.25865-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-02-09T00:08:48.059429-08:00","labels":["testing"],"dependencies":[{"issue_id":"avemu-71h.12","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:58.259456-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.12","depends_on_id":"avemu-71h.10","type":"blocks","created_at":"2026-01-13T19:48:19.626939-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.13","title":"Handle invalid commands via framing.invalid_commands setting","description":"Implement proper handling of invalid/unknown commands based on protocol's framing.invalid_commands setting.\n\n## Framing Configuration\n```yaml\nframing:\n  invalid_commands: ignored | error | echo\n```\n\n- **ignored**: Silently drop unknown commands (no response)\n- **error**: Return error response\n- **echo**: Echo back the command\n\n## Current Behavior\n```python\n# handlers/default.py\nif not action_id:\n    LOG.warning(f'No command found for: {text}')\n    return '***ERROR***'\n```\n\n## New Behavior\n```python\n# EmulatorClient handles this based on protocol.framing.invalid_commands\n# Need to ensure Server class respects this behavior\n```\n\n## Files to verify\n- avemu.py (Server class error handling)\n\n## Acceptance\n- Unknown commands handled per protocol's framing.invalid_commands\n- Error responses match protocol format","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:47:10.729491-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.476006-08:00","closed_at":"2026-01-13T20:01:06.476008-08:00","dependencies":[{"issue_id":"avemu-71h.13","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:47:10.730191-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.13","depends_on_id":"avemu-71h.4","type":"blocks","created_at":"2026-01-13T19:48:21.075461-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.14","title":"Update version number to 0.1.0","description":"Bump avemu version to 0.1.0 to reflect the major pyavcontrol 2.0 migration.\n\n## Version Strategy\n- Current: 0.0.1 (beta)\n- New: 0.1.0 (significant API migration, still beta)\n\n## Files to Update\n- pyproject.toml (version field)\n- README.md (if version referenced)\n\n## Acceptance\n- Version reflects the significant migration work\n- CHANGELOG or release notes document the migration","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:47:11.810608-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:26.429453-08:00","closed_at":"2026-01-13T20:14:26.429453-08:00","close_reason":"Completed during pyavcontrol 1.0 migration","dependencies":[{"issue_id":"avemu-71h.14","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:47:11.811269-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.2","title":"Refactor avemu.py to use new ProtocolLibrary API","description":"Update avemu.py main entry point to use the new pyavcontrol 2.0 API.\n\n## Current Code (v1.0)\n```python\nfrom pyavcontrol import DeviceModelLibrary\nlibrary = DeviceModelLibrary.create()\nmodel = library.load_model(args.model)\nprotocol = model.definition['protocol']\n```\n\n## New Code (v2.0)\n```python\nfrom pyavcontrol import ProtocolLibrary, EmulatorClient\nlibrary = ProtocolLibrary()\nprotocol = library.load('mcintosh/mx160')  # slash-separated ID\nemulator = EmulatorClient(protocol)\n```\n\n## Changes Required\n- Replace DeviceModelLibrary.create() with ProtocolLibrary()\n- Replace load_model() with load()\n- Support both underscore (mcintosh_mx160) and slash (mcintosh/mx160) formats for backward compatibility\n- Update list_protocols() usage for --supported flag\n- Access framing settings via protocol.framing instead of model.definition['protocol']\n\n## Files to modify\n- avemu.py\n\n## Acceptance\n- ProtocolLibrary loads protocols correctly\n- Protocol ID format conversion works\n- --supported flag lists protocols correctly","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:45:50.402493-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.418485-08:00","closed_at":"2026-01-13T20:01:06.418497-08:00","labels":["core"],"dependencies":[{"issue_id":"avemu-71h.2","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:45:50.403316-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.2","depends_on_id":"avemu-71h.1","type":"blocks","created_at":"2026-01-13T19:47:57.63229-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.3","title":"Replace DefaultHandler with EmulatorClient","description":"Replace the custom DefaultHandler implementation with the new EmulatorClient from pyavcontrol 2.0.\n\n## Current Architecture\n```\navemu.py -\u003e DefaultHandler -\u003e _build_canned_responses() -\u003e regex patterns\n```\n\nThe DefaultHandler manually:\n- Builds command registries from api.{group}.actions.{action}\n- Stores regex patterns and canned responses\n- Returns static responses from test cases\n\n## New Architecture\n```\navemu.py -\u003e EmulatorClient.process_command(raw_bytes) -\u003e response_bytes\n```\n\nEmulatorClient provides:\n- Automatic command identification from protocol definitions\n- State tracking via DeviceState\n- Dynamic response generation via ResponseParser\n- Proper handling of set commands vs query commands\n\n## Migration Steps\n1. Remove DefaultHandler instantiation\n2. Create EmulatorClient(protocol) after loading protocol\n3. Replace handler.handle_command(text) with emulator.process_command(bytes)\n4. Handle encoding conversion (text \u003c-\u003e bytes)\n5. Remove handlers/default.py after migration complete\n\n## Files to modify\n- avemu.py\n- handlers/default.py (delete after migration)\n- handlers/__init__.py (may simplify or keep EmulatorHandler base for future)\n\n## Acceptance\n- Commands are processed via EmulatorClient\n- Responses match expected format\n- Stateful commands work correctly","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:45:51.638592-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.42987-08:00","closed_at":"2026-01-13T20:01:06.429873-08:00","labels":["core"],"dependencies":[{"issue_id":"avemu-71h.3","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:45:51.639436-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.3","depends_on_id":"avemu-71h.2","type":"blocks","created_at":"2026-01-13T19:47:58.978551-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.4","title":"Update Server class for EmulatorClient integration","description":"Update the Server class in avemu.py to work with EmulatorClient instead of text-based handler.\n\n## Current Server.run() Flow\n```python\nprotocol = self._model.definition['protocol']\ncmd_separator = protocol.get('command_separator', '\\n')\ncmd_eol = protocol.get('command_eol', '')\nmsg_eol = protocol.get('message_eol', '')\n\n# Text-based processing\ndecoded_data = data.decode(self._handler.encoding)\nrequests = decoded_data.split(cmd_eol)\nresponse = self._handler.handle_command(req)  # text in, text out\n```\n\n## New Flow with EmulatorClient\n```python\n# Access framing from ProtocolDefinition\nframing = self._protocol.framing\nsuffix = framing.suffix if framing else '\\r'\n\n# Bytes-based processing\nresponse = self._emulator.process_command(data)  # bytes in, bytes out\nself._socket.send(response)\n```\n\n## Key Changes\n1. Replace model.definition['protocol'] access with protocol.framing\n2. Remove text encoding/decoding layer (EmulatorClient handles it)\n3. Pass EmulatorClient to Server instead of handler + model\n4. Handle framing.suffix, framing.prefix, framing.case_sensitive\n\n## Files to modify\n- avemu.py\n\n## Acceptance\n- Server correctly processes raw bytes through EmulatorClient\n- Framing (prefix/suffix) handled correctly\n- Multiple concurrent clients still supported","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:12.19729-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.439563-08:00","closed_at":"2026-01-13T20:01:06.439566-08:00","labels":["core"],"dependencies":[{"issue_id":"avemu-71h.4","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:12.198238-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.4","depends_on_id":"avemu-71h.3","type":"blocks","created_at":"2026-01-13T19:48:00.065689-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.5","title":"Add protocol ID format backward compatibility","description":"Support both underscore (mcintosh_mx160) and slash (mcintosh/mx160) protocol ID formats for backward compatibility.\n\n## Current CLI Usage\n```bash\npython avemu.py --model mcintosh_mx160\n```\n\n## New pyavcontrol Format\n```\nmcintosh/mx160  # slash-separated\n```\n\n## Implementation\n```python\ndef normalize_protocol_id(model_arg: str) -\u003e str:\n    '''Convert underscore format to slash format for ProtocolLibrary.'''\n    return model_arg.replace('_', '/')\n\n# In main():\nprotocol_id = normalize_protocol_id(args.model)\nprotocol = library.load(protocol_id)\n```\n\n## Acceptance\n- Both --model mcintosh_mx160 and --model mcintosh/mx160 work\n- Error messages show the user-provided format\n- --supported shows both formats for discoverability","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:13.748983-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.449207-08:00","closed_at":"2026-01-13T20:01:06.44921-08:00","dependencies":[{"issue_id":"avemu-71h.5","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:13.749684-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.5","depends_on_id":"avemu-71h.2","type":"blocks","created_at":"2026-01-13T19:48:01.470164-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.6","title":"Update --supported flag for new API","description":"Update the --supported flag to work with the new ProtocolLibrary API.\n\n## Current Code\n```python\nlibrary = DeviceModelLibrary.create()\nif args.supported:\n    print(format_data_into_columns(sorted(list(library.supported_models()))))\n```\n\n## New Code\n```python\nlibrary = ProtocolLibrary()\nif args.supported:\n    protocols = library.list_protocols()  # returns ['mcintosh/mx160', ...]\n    # show both formats for user convenience\n    display_list = []\n    for p in protocols:\n        display_list.append(p)\n        display_list.append(p.replace('/', '_'))  # also show underscore format\n    print(format_data_into_columns(sorted(set(display_list))))\n```\n\n## Files to modify\n- avemu.py\n\n## Acceptance\n- --supported lists all available protocols\n- Both slash and underscore formats shown\n- Output is properly formatted in columns","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:14.869638-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.457783-08:00","closed_at":"2026-01-13T20:01:06.457785-08:00","dependencies":[{"issue_id":"avemu-71h.6","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:14.870318-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.6","depends_on_id":"avemu-71h.2","type":"blocks","created_at":"2026-01-13T19:48:02.59493-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.7","title":"Access connection settings from new ProtocolDefinition","description":"Update port defaulting logic to use new ProtocolDefinition.connection structure.\n\n## Current Code\n```python\nif device_default_port := model.definition['connection'].get('ip', {}).get('port'):\n    port = device_default_port\n```\n\n## New Code\n```python\nif protocol.connection and protocol.connection.ip:\n    if protocol.connection.ip.port:\n        port = protocol.connection.ip.port\n```\n\n## ProtocolDefinition Structure\n```python\nclass Connection(BaseModel):\n    rs232: RS232Settings | None = None\n    ip: IPSettings | None = None\n\nclass IPSettings(BaseModel):\n    port: int\n    timeout: float = 2.0\n```\n\n## Files to modify\n- avemu.py\n\n## Acceptance\n- Default port extracted correctly from protocol.connection.ip.port\n- Works for protocols without IP settings (falls back to DEFAULT_PORT)","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:32.904521-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:01:06.467083-08:00","closed_at":"2026-01-13T20:01:06.467085-08:00","dependencies":[{"issue_id":"avemu-71h.7","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:32.905423-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.7","depends_on_id":"avemu-71h.2","type":"blocks","created_at":"2026-01-13T19:48:04.459565-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.8","title":"Clean up handlers module after migration","description":"After EmulatorClient migration is complete, clean up the handlers module.\n\n## Files to Evaluate\n- handlers/__init__.py - Keep EmulatorHandler base class? Or remove if not needed\n- handlers/default.py - Delete completely (replaced by EmulatorClient)\n\n## Decision Points\n1. Keep handlers/__init__.py if:\n   - Want to support custom handler overrides in future\n   - format_data_into_columns() utility is still needed\n   \n2. Delete handlers/ entirely if:\n   - EmulatorClient covers all use cases\n   - No need for custom handler extension\n\n## Recommendation\nKeep handlers/__init__.py with just the utility functions (format_data_into_columns).\nDelete handlers/default.py completely.\n\n## Files to modify\n- handlers/default.py (delete)\n- handlers/__init__.py (simplify)\n\n## Acceptance\n- No dead code remains\n- Utility functions preserved if still used\n- Tests still pass","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:34.028734-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:26.424083-08:00","closed_at":"2026-01-13T20:14:26.424083-08:00","close_reason":"Completed during pyavcontrol 1.0 migration","dependencies":[{"issue_id":"avemu-71h.8","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:34.029413-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.8","depends_on_id":"avemu-71h.4","type":"blocks","created_at":"2026-01-13T19:48:13.820392-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-71h.9","title":"Update Dockerfile for pyavcontrol 2.0","description":"Update Dockerfile to work with pyavcontrol 2.0 dependencies.\n\n## Current Dockerfile\n```dockerfile\nFROM python:3.13-rc-slim\nARG MODEL=mcintosh_mx160\n# ... installs from requirements.txt\n```\n\n## Changes Needed\n1. Ensure pyavcontrol 2.0 can be installed in container\n2. Update MODEL ARG default format if needed\n3. Test container builds successfully\n4. Verify emulation works in container\n\n## Files to modify\n- Dockerfile\n\n## Acceptance\n- Docker build succeeds\n- Container runs with pyavcontrol 2.0\n- Emulation works in containerized environment","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T19:46:35.625318-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T20:14:45.291856-08:00","closed_at":"2026-01-13T20:14:45.291856-08:00","close_reason":"Fixed handlers/ reference removal","dependencies":[{"issue_id":"avemu-71h.9","depends_on_id":"avemu-71h","type":"parent-child","created_at":"2026-01-13T19:46:35.625938-08:00","created_by":"Ryan Snodgrass"},{"issue_id":"avemu-71h.9","depends_on_id":"avemu-71h.1","type":"blocks","created_at":"2026-01-13T19:48:15.380981-08:00","created_by":"Ryan Snodgrass"}]}
{"id":"avemu-7kl","title":"Fix 29 commands parsing as empty CommandGroup (lyngdorf/cd1, mcintosh/mx123)","description":"Health check TestNoEmptyCommandGroups found 29 flat commands parsing as CommandGroup with empty actions dict. 28 are in lyngdorf/cd1 and 1 is mcintosh/mx123 volume. Root cause: the string response coercion added for MR89 only handles the basic case. These protocols likely have a different variant of the string response format that still fails Command validation, causing Pydantic to fall through to CommandGroup.","notes":"## Analysis (2026-02-08)\n\n### Affected commands (all 29)\n**lyngdorf/cd1** (28 commands): communication_test, power_toggle, power_on, power_off, ir_enable, ir_disable, ir_toggle, volume_up, set_address, show_software_version, factory_reset, play, stop, eject, previous_track, next_track, scan_backward_start, scan_forward_start, scan_stop, select_track, repeat_set, repeat_toggle, random_set, random_toggle, ab_repeat, sample_rate_set, dac_gain_set, state_query\n\n**mcintosh/mx123** (1 command): volume\n\n### Root cause\nWhen Pydantic validates a YAML command entry as \\`Command | CommandGroup\\` (discriminated union), it tries \\`Command\\` first. If any field fails validation, Pydantic silently falls through to \\`CommandGroup\\`. Since flat commands don't have an \\`actions\\` dict, the result is a CommandGroup with empty \\`commands\\` — effectively a dead command.\n\nThe string response coercion fix (schema.py \\`normalize_command_fields\\`) converts \\`response: \"string\"\\` to \\`response_pattern: \"string\"\\`. This fixed MR89 but these 29 commands likely have a different issue causing Command validation to fail.\n\n### Code path\n1. YAML loads command with some field that fails \\`Command\\` model validation\n2. Pydantic tries \\`CommandGroup\\` next\n3. CommandGroup accepts the entry but has no actions → empty \\`commands\\` dict\n4. \\`CommandBuilder._iter_commands()\\` skips the entry entirely\n\n### Investigation needed\n- Read lyngdorf/cd1.yaml to see what field format causes the fallback\n- Read mcintosh/mx123.yaml volume command specifically\n- lyngdorf/cd1 uses \\`encoding: binary\\` which may compound the issue\n- May need to check if the \\`response_pattern\\` coercion handles all string response variants\n\n### Fix strategy\n1. Inspect the YAML for the 29 failing commands to identify the exact validation error\n2. Add appropriate coercion in \\`normalize_command_fields\\` or relax the Command model\n3. If lyngdorf/cd1 is binary encoding, may overlap with avemu-aqn\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestNoEmptyCommandGroups -v\\`\n\n### Related issues\n- avemu-m5z: Schema validation (overlapping root cause)\n- avemu-aqn: Binary encoding (lyngdorf/cd1 is binary)","status":"open","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:20:52.541643-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:52:35.453259-08:00"}
{"id":"avemu-aqn","title":"Add binary/JSON encoding support to emulator","description":"27 protocols use non-text encodings (26 'binary', 1 'json') that the current text-based emulator cannot handle. These are correctly documented protocols — not errors. Binary protocols: Arcam MZ8/MZ12, Lexicon MC series, Parasound HALO, Primare SP series, Crown HiQnet, Marantz BD disc players, Theta Casablanca III. JSON protocol: Monoprice Monolith HTP-1. Binary protocols use structured byte packets (not ASCII text) with headers, checksums, and fixed-length fields. JSON protocol uses HTTP/WebSocket transport. The health check correctly skips these in emulation tests. Future work: build binary and HTTP emulation engines.","notes":"## Analysis (2026-02-08)\n\n### Affected protocols (27 total)\n\n**Binary encoding (26 protocols):**\n| Brand | Models | Protocol type |\n|-------|--------|---------------|\n| Arcam | MZ8, MZ12 | IR/RS-232 matrix amplifiers, proprietary byte framing |\n| Crown | HiQnet family | HiQnet binary protocol with structured message headers |\n| Lexicon | MC-1, MC-4, MC-8, MC-10, MC-12, MC-12 Balance, MC-14, RV-6, RV-9 | Proprietary binary control |\n| Marantz | BD7004, BD8002, UD7007, UD8004 | Blu-ray disc players, binary serial |\n| Parasound | HALO C1, C2, P5, P6, NewClassic 200 Pre | Proprietary binary over RS-232 |\n| Primare | SP31, SP31.7, SP32, SP33 | Binary control protocol |\n| Theta | Casablanca III | Binary control protocol |\n| Lyngdorf | CD1 | Binary CD player protocol |\n\n**JSON encoding (1 protocol):**\n| Brand | Model | Protocol type |\n|-------|-------|---------------|\n| Monoprice | Monolith HTP-1 | HTTP/WebSocket REST API with JSON payloads |\n\n### Why these can't be emulated today\nThe current emulator (EmulatorClient) is text-based:\n1. Receives bytes → decodes to string using protocol encoding\n2. Matches against regex patterns built from command templates\n3. Generates response strings → encodes back to bytes\n\nBinary protocols don't have text commands. They use:\n- Fixed-length headers with message type, length, checksum fields\n- Binary-encoded parameter values (not ASCII digits)\n- Packet framing (STX/ETX or length-prefixed)\n\nJSON protocols use HTTP request/response, not serial byte streams.\n\n### Fix strategy\nThis is a new capability, not a bug fix:\n\n**Binary protocols**: Need a \\`BinaryEmulatorClient\\` that:\n1. Parses incoming bytes using packet structure definitions\n2. Matches by message type/opcode rather than regex\n3. Builds response packets from binary templates\n4. Handles checksums, length fields, etc.\n\n**JSON protocols**: Need an \\`HttpEmulatorClient\\` that:\n1. Runs an HTTP server (not TCP socket)\n2. Routes requests by URL path and method\n3. Returns JSON responses\n\nBoth are significant new features. For now, the health checks correctly skip these protocols (\\`_emulatable_protocols()\\` filters by supported encoding).\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestSupportedEncoding -v\\`\n\n### Related issues\n- avemu-7kl: lyngdorf/cd1 appears in empty CommandGroup list AND binary encoding list","status":"open","priority":3,"issue_type":"feature","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:21:10.534577-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:56:29.323191-08:00"}
{"id":"avemu-eer","title":"Zone query response resolution for flat commands","status":"closed","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T00:13:21.208321-08:00","created_by":"Ryan","updated_at":"2026-02-09T00:18:01.229792-08:00","closed_at":"2026-02-09T00:18:01.229792-08:00","close_reason":"Closed"}
{"id":"avemu-eh3","title":"Filter out binary and authenticated protocols from device list","description":"Update avemu to use `is_simple_protocol()` filter from pyavcontrol.\n\n**Change in device listing:**\n```python\n# Only list devices compatible with text-based emulation\nprotocols = [p for p in library.list_protocols() \n             if library.load(p).is_simple_protocol()]\n```\n\n**Applies to both RS232 and IP emulation.**\n\n**Result:**\n- Binary protocols (26 JVC, Arcam, etc.) excluded from --list\n- Authenticated protocols (Sony ADCP) excluded\n- Warning if user manually specifies incompatible protocol\n\n**Depends on:** pyavcontrol adding `is_simple_protocol()` method","status":"closed","priority":2,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-02-01T18:13:46.14289-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-02-01T18:47:30.437561-08:00","closed_at":"2026-02-01T18:47:30.437561-08:00","close_reason":"Added is_simple_protocol() filtering to list and warning on load"}
{"id":"avemu-hk9","title":"Embedded EOL in command templates breaks matching","status":"closed","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T00:13:20.138657-08:00","created_by":"Ryan","updated_at":"2026-02-09T00:18:01.210619-08:00","closed_at":"2026-02-09T00:18:01.210619-08:00","close_reason":"Closed"}
{"id":"avemu-iko","title":"Fix 138 protocols that load but have zero commands","description":"Health check TestProtocolCommandsExist found 138 protocols that pass schema validation but have no commands. These are either extends-only stubs where the base protocol has no commands section, or protocols where commands are defined in command_families but not getting resolved into the commands dict.","notes":"## Analysis (2026-02-08)\n\n### Scope\n138 out of 692 loadable protocols (20%) have zero commands after loading.\n\n### Likely root causes\n1. **extends-only stubs**: Protocols like OPPO UDP-205 (before fix) that extend a base with no commands section. The child inherits nothing.\n2. **command_families not resolved**: Some protocols define commands in a command_families section that may not get converted to the commands dict during loading.\n3. **Base protocol has commands but child overrides with empty**: Inheritance may clear commands if child has an empty commands section.\n\n### Investigation needed\n- Sample 10-20 of the 138 to categorize root cause distribution\n- Check if command_families entries are supposed to be auto-expanded into commands\n- Check if some are genuinely command-less (e.g., amplifiers with no control protocol)\n\n### Fix strategy\nDepends on root cause category:\n1. For bad extends targets: fix the extends reference (like OPPO UDP-205)\n2. For command_families resolution: fix the loader to expand command_families into commands\n3. For genuinely command-less protocols: may be correct (e.g., passive devices) — document as such\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestProtocolCommandsExist -v\\`\n\n### Related issues\n- avemu-m5z: Schema validation (overlapping — some protocols fail to load AND have zero commands)\n- avemu-aqn: Binary encoding (some zero-command protocols may be binary-only)","status":"open","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T07:54:14.204075-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:54:14.204075-08:00"}
{"id":"avemu-j96","title":"Add VHS demo tape showing avemu in action","description":"Create an animated demo using charmbracelet/vhs (https://github.com/charmbracelet/vhs) that shows avemu in action.\n\n## What to create:\n1. A VHS tape file (.tape) with commands that demonstrate avemu\n2. A test script that sends commands to the emulator (power on/off, volume changes, queries)\n3. The generated GIF to embed in README.md\n\n## Demo should show:\n- Starting avemu with --model mcintosh/mx160 --tui\n- A separate terminal connecting via nc localhost 84\n- Sending various commands and receiving responses\n- State changes visible in the TUI\n\n## Files to create:\n- demo/avemu.tape - VHS tape definition\n- demo/test_client.sh - Script that sends commands to emulator\n- demo/avemu-demo.gif - Generated demo (add to .gitignore if large)","status":"closed","priority":3,"issue_type":"task","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T20:11:18.494963-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T21:09:21.807049-08:00","closed_at":"2026-01-13T21:09:21.807049-08:00","close_reason":"Created VHS demo tape and animated GIF, added to README"}
{"id":"avemu-m5z","title":"Fix 429 protocols failing schema validation on load","description":"Health check TestProtocolsLoad found 429/1159 protocols fail to load due to Pydantic validation errors, plus 38 NAD protocols have missing extends targets (467 total). Top failure fields: command_families (1201 errors), capabilities (170), enumerations (145), commands (96), feedback (84), framing (45), connection (43), protocol (28). Most are schema strictness issues where YAML fields don't match the ProtocolDefinition model (e.g., float values where int expected, dict where int expected). Capabilities issues should be addressed through avemu-4eq (restructure Capabilities model). NAD missing extends targets (_classic.yaml, _bluos.yaml, _receiver.yaml) are a separate sub-task.","notes":"## Analysis (2026-02-08)\n\n### Scope\n- 429 schema validation failures + 38 missing extends targets = 467 total\n- Only 692/1159 protocols load successfully\n\n### Validation error breakdown by field\n| Field | Error count |\n|-------|-------------|\n| command_families | 1201 |\n| capabilities | 170 |\n| enumerations | 145 |\n| commands | 96 |\n| feedback | 84 |\n| framing | 45 |\n| connection | 43 |\n| protocol | 28 |\n| transport_notes | 24 |\n| device | 18 |\n| responses | 10 |\n| timing | 9 |\n\n### Root causes\n1. **command_families** (biggest): Many protocols use a `command_families` section with fields like `range_min: -95.5` (float) where the Pydantic model expects int. Anthem AVM-2/20/30/40/50 all fail on `VM.range_min` and `VM.forms[].amount` being floats.\n2. **capabilities**: Protocols put dict values where int expected (e.g., `acurus/act3` has `digital_inputs: {coaxial: 8, toslink: 3}` instead of an int count). The `Capabilities` model (schema.py:807) uses `extra='ignore'` but typed fields like `digital_inputs` need to match.\n3. **enumerations**: Some protocols define enumerations with non-string keys or values that fail Pydantic validation.\n4. **Missing extends targets**: All 38 are NAD protocols referencing `_classic.yaml`, `_bluos.yaml`, or `_receiver.yaml` base files that don't exist yet.\n\n### Fix strategy\nTwo parallel approaches:\n1. **Relax schema validation** where the model is too strict — add `float` to fields that should accept it (e.g., `range_min`), allow dict for `digital_inputs`/`analog_inputs`, etc. File: `avcontrol/pyavcontrol/schema.py`\n2. **Create missing NAD base files** in `avcontrol-docs/protocols/nad/` — `_classic.yaml`, `_bluos.yaml`, `_receiver.yaml`\n\n### Verification\nRun: `uv run --python 3.12 pytest tests/test_protocol_health.py::TestProtocolsLoad -v`\n\n### Related issues\n- avemu-7kl: Empty CommandGroups (overlapping cause — Command validation fails, falls through)\n- avemu-2qg: Match roundtrip (some failures may be due to loading issues)","status":"open","priority":1,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:20:48.894891-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:56:16.8546-08:00"}
{"id":"avemu-ms8","title":"Fix 5762 responses containing raw regex patterns","description":"Health check TestNoRawRegexInResponses found 5762 commands returning responses with unsubstituted (?P\u003c regex patterns. Affects 300+ protocols across many brands (Anthem, Denon, Integra, Krell, Lyngdorf, McIntosh, Onkyo, Pioneer, Trinnov, etc). Root cause: missing state_change mappings prevent the emulator from substituting state values into response patterns. The _resolve_fields_from_responses() fallback added for MX160 grouped commands helps but doesn't cover all cases (especially flat command protocols). 15 protocols also had runtime errors during testing (KeyError on 'current_zone').","notes":"## Analysis (2026-02-08)\n\n### Scope\n5762 commands across 300+ protocols return raw regex patterns like \\`(?P\u003cvolume\u003e-?\\d+)\\` instead of substituted values. This is the single largest functional issue — it means the emulator returns gibberish for most query commands.\n\n### Affected brands (partial list, sorted by failure count)\nDenon (100+ models), Onkyo (50+ models), Pioneer (50+ models), Integra (40+ models), Anthem (20+ models), Krell (12 models), Lyngdorf (12 models), Boulder (10 models), Classe (10 models), Extron (5 models), Trinnov (6 models), plus Accuphase, Acurus, Atlona, AVPro Edge, Ayre, Cambridge Audio, Datasat, JBL, Kramer, McIntosh MX160, MSB, Sonance, StormAudio, Theta\n\n### Root cause\nThe response generation pipeline (ResponseParser.generate in responses.py) substitutes state values into response patterns. It requires a mapping from capture group names (e.g., \\`volume\\`, \\`power\\`) to state variable values. This mapping comes from:\n\n1. **\\`state_change\\` on the command** — explicit mapping like \\`state_change: {volume: \"{level}\"}\\`. Most protocols DON'T have this.\n2. **\\`_resolve_fields_from_responses()\\` fallback** — looks at unsolicited response \\`updates\\` mappings. Only works for grouped commands with matching response definitions.\n3. **Group name fallback** — if the command group name matches a state variable and the response has a single capture group.\n\nFor most flat-command protocols (Denon, Onkyo, Pioneer, Integra), none of these fallbacks work because:\n- No \\`state_change\\` on commands\n- No unsolicited response definitions\n- Command names don't map directly to state variable names\n\n### Code path\n1. \\`EmulatorClient._generate_response()\\` (client.py) calls \\`_build_template_values()\\`\n2. \\`_build_template_values()\\` tries state_change mapping, then _resolve_fields_from_responses fallback\n3. If no values found, the regex pattern passes through unsubstituted\n4. \\`ResponseParser._generate_from_pattern()\\` returns the raw regex as the response\n\n### 15 runtime errors\nKeyError on 'current_zone' — some protocols reference state variables that don't exist in the default state. These are separate from the substitution failures.\n\n### Fix strategy (three tiers)\n**Tier 1 — Auto-resolve from response pattern capture groups**\nFor commands with a single capture group matching a state variable name, auto-map it. E.g., if response pattern has \\`(?P\u003cvolume\u003e...)\\` and state has \\`volume\\`, use it directly. This is the simplest fix and would cover many cases.\n\n**Tier 2 — Infer from command name**\nFor flat commands like \\`volume_query\\`, infer the state variable is \\`volume\\` by stripping common suffixes (_query, _get, _status). Map the response capture groups accordingly.\n\n**Tier 3 — Add state_change to protocols**\nFor the remaining cases, add explicit \\`state_change\\` mappings to protocol YAML files. This is the most work but the most correct.\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestNoRawRegexInResponses -v\\`\n\n### Related issues\n- avemu-2qg: Match roundtrip failures (if command doesn't match, response gen is never reached)\n- avemu-s0j: Python literals (overlapping — some responses have both regex AND literals)\n- avemu-m5z: Schema validation (some protocols can't load at all, reducing the testable set)","status":"open","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:21:00.065057-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:53:20.485214-08:00"}
{"id":"avemu-s0j","title":"Fix 50 responses with Python True/False/None literals","description":"Health check TestNoPythonLiteralsInResponses found 50 commands returning responses containing literal Python 'True', 'False', or 'None' strings. All are Lyngdorf protocols (mp40, mp50, mp60, p1, srp50, tdai series). The source.get, audio_mode.get, input_format.get commands return None values for uninitialized state variables. Fix: ensure default state values are provided for all response capture groups, and handle None encoding in response generation.","notes":"## Analysis (2026-02-08)\n\n### Affected protocols and commands (all 50)\nAll Lyngdorf family — same commands fail across every model:\n\n| Command | Models affected |\n|---------|----------------|\n| source.get/next/previous | mp40, mp40-21, mp50, mp60, mp60-21, p1, srp50, tdai1120, tdai2170, tdai2200, tdai3400mk2 |\n| zone2_source.get | mp40, mp50, mp60 |\n| audio_mode.get/next/previous | mp40, mp50, mp60 |\n| input_format.get | mp40, mp50, mp60 |\n\n### Example output\n\\`source.get\\` returns: \\`!SRC(None,\"None\")\\` — should be something like \\`!SRC(1,\"Analog 1\")\\`\n\n### Root cause\nThe Lyngdorf source/audio_mode responses have TWO capture groups — a numeric ID and a name string:\n\\`!SRC((?P\u003cid\u003e\\d+),\"(?P\u003cname\u003e[^\"]*)\")\\`\n\nThe state variables for these (e.g., \\`source\\`, \\`audio_mode\\`) are initialized as \\`None\\` because the protocol's \\`state:\\` section doesn't define defaults for them, or they need compound state (both id and name).\n\nWhen \\`_encode_value()\\` receives \\`None\\`, it returns the string \\`\"None\"\\` instead of a sensible default.\n\n### Code path\n1. \\`_build_template_values()\\` looks up state variable for capture group \\`id\\` and \\`name\\`\n2. State variable is \\`None\\` (no default defined)\n3. \\`_encode_value(None, ...)\\` returns \\`str(None)\\` = \\`\"None\"\\`\n4. Response becomes \\`!SRC(None,\"None\")\\`\n\n### Fix strategy\nTwo complementary fixes:\n1. **Handle None in _encode_value()**: Return type-appropriate defaults when value is None — \\`\"0\"\\` for numeric types, \\`\"\"\\` for strings. File: \\`avcontrol/pyavcontrol/responses.py\\`\n2. **Add default state values**: Ensure Lyngdorf protocols define sensible defaults for source, audio_mode, input_format in their \\`state:\\` sections. File: \\`avcontrol-docs/protocols/lyngdorf/_base.yaml\\` or individual models\n\n### Verification\nRun: \\`uv run --python 3.12 pytest tests/test_protocol_health.py::TestNoPythonLiteralsInResponses -v\\`\n\n### Related issues\n- avemu-ms8: Raw regex in responses (some Lyngdorf commands appear in both lists)","status":"open","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T02:21:04.097764-08:00","created_by":"Ryan","updated_at":"2026-02-09T07:53:37.123866-08:00"}
{"id":"avemu-u9c","title":"test_response_ends_with_protocol_eol fails for IGNORED/TIMEOUT framing","status":"closed","priority":3,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T00:13:23.983812-08:00","created_by":"Ryan","updated_at":"2026-02-09T00:18:01.262597-08:00","closed_at":"2026-02-09T00:18:01.262597-08:00","close_reason":"Closed"}
{"id":"avemu-vta","title":"Bool state values not encoded as 0/1 in int-typed responses","status":"closed","priority":2,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-02-09T00:13:22.885599-08:00","created_by":"Ryan","updated_at":"2026-02-09T00:18:01.247035-08:00","closed_at":"2026-02-09T00:18:01.247035-08:00","close_reason":"Closed"}
{"id":"avemu-wlj","title":"Fix schema/emulator response generation","description":"Commands are being identified but responses aren't generated correctly. Issues:\n\n1. Response generation in EmulatorClient._generate_response() needs to work with CommandGroup.actions structure\n2. ResponseParser.generate() expects specific action names (query, get) but receives 'default'\n3. DeviceState.has() method doesn't exist\n4. Some YAML fields (response.fields as strings) don't match schema expectations\n\nFiles to fix:\n- pyavcontrol/client.py - EmulatorClient response generation\n- pyavcontrol/responses.py - ResponseParser.generate()\n- pyavcontrol/schema.py - Response.fields type flexibility","status":"closed","priority":1,"issue_type":"bug","owner":"rsnodgrass@gmail.com","created_at":"2026-01-13T20:46:55.587645-08:00","created_by":"Ryan Snodgrass","updated_at":"2026-01-13T21:01:10.243179-08:00","closed_at":"2026-01-13T21:01:10.243179-08:00","close_reason":"Fixed schema/emulator response generation - all legacy format conversions working"}
